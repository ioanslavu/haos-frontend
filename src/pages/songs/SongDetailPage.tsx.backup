import { useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { ArrowLeft, Calendar, Clock, Loader2, Plus, Upload } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Skeleton } from '@/components/ui/skeleton';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { StageBadge } from '@/components/songs/StageBadge';
import { ProgressBar } from '@/components/songs/ProgressBar';
import { ChecklistSection } from '@/components/songs/ChecklistSection';
import { ActivityLogItem, ActivityType } from '@/components/songs/ActivityLogItem';
import { AssetCard } from '@/components/songs/AssetCard';
import { UploadAssetDialog } from '@/components/songs/UploadAssetDialog';
import { SongInfoCard } from '@/components/songs/SongInfoCard';
import { AddNoteForm } from '@/components/songs/AddNoteForm';
import { RecordingTab } from '@/components/songs/RecordingTab';
import { ReleaseDetailsCard } from '@/components/songs/ReleaseDetailsCard';
import { PlatformDistributionList } from '@/components/songs/PlatformDistributionList';
import { PublicationStatusTimeline } from '@/components/songs/PublicationStatusTimeline';
import { CreateWorkDialog } from '@/components/songs/CreateWorkDialog';
import { CreateReleaseDialog } from '@/components/songs/CreateReleaseDialog';
import { ContractsTab } from '@/components/songs/ContractsTab';
import {
  fetchSongDetail,
  fetchChecklist,
  toggleChecklistItem,
  validateAllChecklist,
  transitionSong,
  sendToMarketing,
  sendToDigital,
  fetchNotes,
  fetchStageTransitions,
  fetchAssets,
  reviewAsset,
  createNote,
  fetchSongWork,
  fetchReleasePublications,
} from '@/api/songApi';
import catalogService from '@/api/services/catalog.service';
import { useAuthStore } from '@/stores/authStore';
import { useToast } from '@/hooks/use-toast';
import { formatDistanceToNow } from 'date-fns';
import { AppLayout } from '@/components/layout/AppLayout';
import { SongStageTransition, SongNote, SongChecklistItem, SongAsset } from '@/types/song';

export default function SongDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const { user } = useAuthStore();
  const { toast } = useToast();
  const [activeTab, setActiveTab] = useState('overview');
  const [showUploadAssetDialog, setShowUploadAssetDialog] = useState(false);
  const [showAddNote, setShowAddNote] = useState(false);
  const [activityFilter, setActivityFilter] = useState<'all' | ActivityType>('all');
  const [showCreateWorkDialog, setShowCreateWorkDialog] = useState(false);
  const [showCreateReleaseDialog, setShowCreateReleaseDialog] = useState(false);

  const songId = parseInt(id || '0');

  // Queries
  const { data: songData, isLoading: songLoading } = useQuery({
    queryKey: ['song', songId],
    queryFn: () => fetchSongDetail(songId),
    enabled: !!songId,
  });

  const { data: checklistData, isLoading: checklistLoading } = useQuery({
    queryKey: ['song-checklist', songId],
    queryFn: () => fetchChecklist(songId),
    enabled: !!songId,
  });

  const { data: notesData } = useQuery({
    queryKey: ['song-notes', songId],
    queryFn: () => fetchNotes(songId),
    enabled: !!songId,
  });

  const { data: transitionsData } = useQuery({
    queryKey: ['song-transitions', songId],
    queryFn: () => fetchStageTransitions(songId),
    enabled: !!songId,
  });

  const { data: assetsData } = useQuery({
    queryKey: ['song-assets', songId],
    queryFn: () => fetchAssets(songId),
    enabled: !!songId,
  });

  const { data: workData, isLoading: workLoading, error: workError } = useQuery({
    queryKey: ['song-work', songId],
    queryFn: () => fetchSongWork(songId),
    enabled: !!songId && activeTab === 'work',
  });

  const song = songData?.data;
  const checklist = Array.isArray(checklistData?.data) ? checklistData.data : [];
  const notes = Array.isArray(notesData?.data) ? notesData.data : [];
  const transitions = Array.isArray(transitionsData?.data) ? transitionsData.data : [];
  const assets = Array.isArray(assetsData?.data) ? assetsData.data : [];
  const work = workData?.data;

  // Release queries
  const { data: releaseData, isLoading: releaseLoading } = useQuery({
    queryKey: ['release', song?.release?.id],
    queryFn: () => catalogService.getRelease(song!.release!.id),
    enabled: !!song?.release?.id && activeTab === 'release',
  });

  const { data: publicationsData, isLoading: publicationsLoading } = useQuery({
    queryKey: ['release-publications', song?.release?.id],
    queryFn: () => fetchReleasePublications(song!.release!.id),
    enabled: !!song?.release?.id && activeTab === 'release',
  });

  const publications = Array.isArray(publicationsData?.data) ? publicationsData.data : [];

  // Mutations
  const toggleChecklistMutation = useMutation({
    mutationFn: (itemId: number) => toggleChecklistItem(songId, itemId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-checklist', songId] });
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
    },
  });

  const validateAllMutation = useMutation({
    mutationFn: () => validateAllChecklist(songId),
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: ['song-checklist', songId] });
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Validation Complete',
        description: `${response.data.validated_count} items validated.`,
      });
    },
  });

  const sendToMarketingMutation = useMutation({
    mutationFn: () => sendToMarketing(songId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Success',
        description: 'Song sent to Marketing department.',
      });
    },
  });

  const sendToDigitalMutation = useMutation({
    mutationFn: () => sendToDigital(songId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Success',
        description: 'Song sent to Digital Distribution.',
      });
    },
  });

  const reviewAssetMutation = useMutation({
    mutationFn: ({ assetId, action, notes }: { assetId: number; action: 'approve' | 'reject' | 'revision_requested'; notes?: string }) =>
      reviewAsset(songId, assetId, { action, notes }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-assets', songId] });
      toast({
        title: 'Asset Reviewed',
        description: 'Your review has been submitted.',
      });
    },
  });

  const createNoteMutation = useMutation({
    mutationFn: (data: { content: string; is_important: boolean }) => createNote(songId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-notes', songId] });
      setShowAddNote(false);
      toast({
        title: 'Note Added',
        description: 'Your note has been added to the activity log.',
      });
    },
  });

  // Combine and sort all activities
  const allActivities = useMemo(() => {
    type ActivityItem = {
      id: string;
      type: ActivityType;
      data: SongStageTransition | SongNote | SongChecklistItem | SongAsset;
      timestamp: string;
    };

    const items: ActivityItem[] = [];

    // Add transitions
    transitions.forEach((transition) => {
      items.push({
        id: `transition-${transition.id}`,
        type: 'transition',
        data: transition,
        timestamp: transition.created_at,
      });
    });

    // Add notes
    notes.forEach((note) => {
      items.push({
        id: `note-${note.id}`,
        type: 'note',
        data: note,
        timestamp: note.created_at,
      });
    });

    // Add completed checklist items
    checklist
      .filter((item) => item.is_completed && item.completed_at)
      .forEach((item) => {
        items.push({
          id: `checklist-${item.id}`,
          type: 'checklist',
          data: item,
          timestamp: item.completed_at!,
        });
      });

    // Add assets
    assets.forEach((asset) => {
      items.push({
        id: `asset-${asset.id}`,
        type: 'asset',
        data: asset,
        timestamp: asset.created_at,
      });
    });

    // Sort by timestamp (most recent first)
    return items.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
  }, [transitions, notes, checklist, assets]);

  // Filter activities
  const filteredActivities = useMemo(() => {
    if (activityFilter === 'all') {
      return allActivities;
    }
    return allActivities.filter((item) => item.type === activityFilter);
  }, [allActivities, activityFilter]);

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  if (songLoading) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          {/* Header Skeleton */}
          <div className="rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/10 p-8">
            <Skeleton className="h-8 w-64 mb-4" />
            <Skeleton className="h-4 w-32 mb-8" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <Skeleton key={i} className="h-20 rounded-2xl" />
              ))}
            </div>
          </div>
          {/* Tabs Skeleton */}
          <Skeleton className="h-14 rounded-2xl" />
          {/* Content Skeleton */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Skeleton className="lg:col-span-2 h-96 rounded-2xl" />
            <Skeleton className="h-96 rounded-2xl" />
          </div>
        </div>
      </AppLayout>
    );
  }

  }

  if (!song) {
    return (
      <AppLayout>
        <div className="space-y-8 pb-8">
          <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
            <CardContent className="py-12 text-center">
              <p className="text-muted-foreground mb-4">Song not found.</p>
              <Button onClick={() => navigate('/songs')} className="rounded-xl" size="lg">
                <ArrowLeft className="mr-2 h-4 w-4" />
                Back to Songs
              </Button>
            </CardContent>
          </Card>
        </div>
      </AppLayout>
    );
  }


  const { isAdmin } = useAuthStore();

  const canReviewAssets = user?.department === 'Label' && song.current_stage === 'label_review';
  const canUploadAssets =
    (user?.department === 'Marketing' && song.current_stage === 'marketing_assets') ||
    (user?.department === 'Label') ||
    isAdmin();
  const isComplete = song.checklist_progress === 100;
  const currentStage = song.current_stage || 'draft';

  // Permission check for creating work
  const canCreateWork = !song.work && (user?.department === 'Publishing' || isAdmin());

  // Permission check for creating release
  const canCreateRelease =
    !song.release && (
      user?.department === 'Digital' ||
      (user?.department === 'Label' && ['ready_for_digital', 'digital_distribution', 'released'].includes(currentStage)) ||
      isAdmin()
    );

  return (
    <AppLayout>
      <div className="space-y-8 pb-8">
        {/* Modern Glassmorphic Header with Gradient */}
        <div className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 backdrop-blur-xl border border-white/20 dark:border-white/10 p-4 sm:p-6 lg:p-8 shadow-2xl">
          {/* Animated gradient orbs */}
          <div className="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-blue-400/30 to-purple-500/30 rounded-full blur-3xl animate-pulse" />
          <div className="absolute bottom-0 left-0 w-96 h-96 bg-gradient-to-tr from-pink-400/30 to-orange-500/30 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />

          <div className="relative z-10">
            <div className="flex items-center gap-4 mb-6">
              <Button
                variant="ghost"
                size="icon"
                onClick={() => navigate('/songs')}
                className="hover:bg-white/10 transition-colors"
              >
                <ArrowLeft className="h-5 w-5" />
              </Button>
              <div className="flex-1">
                <h1 className="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text">
                  {song.title}
                </h1>
                <p className="text-muted-foreground text-sm sm:text-base lg:text-lg mt-1">
                  {song.artist?.display_name || 'No artist'}
                </p>
              </div>
              {song.current_stage && <StageBadge stage={song.current_stage} />}
            </div>

            {/* Key Metrics Grid */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="rounded-2xl bg-background/50 backdrop-blur-xl border border-white/10 p-4 hover:shadow-lg transition-all">
                <p className="text-xs text-muted-foreground mb-2">Progress</p>
                <ProgressBar progress={song.checklist_progress} showLabel={true} />
              </div>
              <div className="rounded-2xl bg-background/50 backdrop-blur-xl border border-white/10 p-4 hover:shadow-lg transition-all">
                <p className="text-xs text-muted-foreground mb-2">Time in Stage</p>
                <div className="flex items-baseline gap-1">
                  <p className="text-xl font-bold">{song.days_in_current_stage}</p>
                  <p className="text-sm text-muted-foreground">
                    {song.days_in_current_stage === 1 ? 'day' : 'days'}
                  </p>
                </div>
              </div>
              <div className="rounded-2xl bg-background/50 backdrop-blur-xl border border-white/10 p-4 hover:shadow-lg transition-all">
                <p className="text-xs text-muted-foreground mb-2">Target Release</p>
                <p className="text-xl font-bold">
                  {song.target_release_date
                    ? new Date(song.target_release_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : 'Not set'}
                </p>
                {song.is_overdue && (
                  <p className="text-xs text-red-600 mt-1">Overdue</p>
                )}
              </div>
              <div className="rounded-2xl bg-background/50 backdrop-blur-xl border border-white/10 p-4 hover:shadow-lg transition-all">
                <p className="text-xs text-muted-foreground mb-2">Created</p>
                <p className="text-sm font-semibold">
                  {formatDistanceToNow(new Date(song.created_at), { addSuffix: true })}
                </p>
              </div>
            </div>
          </div>
        </div>

      {/* Modern Tabs Section */}
      <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-8">
        <div className="rounded-2xl bg-background/50 backdrop-blur-xl border border-white/10 p-2 shadow-lg">
          <TabsList className="w-full grid grid-cols-3 md:grid-cols-7 gap-2 bg-transparent">
            <TabsTrigger value="overview" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Overview</TabsTrigger>
            <TabsTrigger value="work" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Work</TabsTrigger>
            <TabsTrigger value="recording" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Recording</TabsTrigger>
            <TabsTrigger value="assets" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Assets</TabsTrigger>
            <TabsTrigger value="release" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Release</TabsTrigger>
            <TabsTrigger value="contracts" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Contracts</TabsTrigger>
            <TabsTrigger value="activity" className="rounded-xl data-[state=active]:bg-primary data-[state=active]:text-primary-foreground">Activity</TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="overview" className="space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Checklist Section - Takes up 2 columns */}
            <div className="lg:col-span-2">
              <ChecklistSection
                items={checklist}
                currentStage={currentStage}
                onToggle={(itemId) => toggleChecklistMutation.mutate(itemId)}
                onValidateAll={() => validateAllMutation.mutate()}
                onSendToMarketing={
                  currentStage === 'label_recording'
                    ? () => sendToMarketingMutation.mutate()
                    : undefined
                }
                onSendToDigital={
                  currentStage === 'ready_for_digital'
                    ? () => sendToDigitalMutation.mutate()
                    : undefined
                }
                isValidating={validateAllMutation.isPending}
                isSendingToMarketing={sendToMarketingMutation.isPending}
                isSendingToDigital={sendToDigitalMutation.isPending}
              />
            </div>

            {/* Song Info Card - Takes up 1 column */}
            <div className="lg:col-span-1">
              <SongInfoCard song={song} />
            </div>
          </div>

          {/* Recent Activity */}
          <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
            <CardHeader>
              <CardTitle className="text-xl">Recent Activity</CardTitle>
              <CardDescription>Latest updates and notes</CardDescription>
            </CardHeader>
            <CardContent className="space-y-3">
              {notes.length === 0 ? (
                <div className="text-center py-12">
                  <Clock className="h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-20" />
                  <p className="text-muted-foreground mb-2">No activity yet</p>
                  <p className="text-sm text-muted-foreground">Activity will appear here as work progresses</p>
                </div>
              ) : (
                notes.slice(0, 5).map((note) => (
                  <ActivityLogItem key={note.id} activity={note} type="note" />
                ))
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="work" className="space-y-6">
          {workLoading ? (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardContent className="py-12">
                <div className="flex items-center justify-center">
                  <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                  <span className="ml-2 text-muted-foreground">Loading work details...</span>
                </div>
              </CardContent>
            </Card>
          ) : workError ? (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardContent className="py-12">
                <p className="text-center text-muted-foreground">
                  {song.work ? 'Failed to load work details' : 'No work linked to this song yet.'}
                </p>
                  <div className="flex justify-center">
                    <Button
                      onClick={() => setShowCreateWorkDialog(true)}
                      
                      size="lg"
                      
                      className="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                    >
                      <Plus className="h-5 w-5 mr-2" />
                      Create Work
                    </Button>
                  </div>
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          ) : work ? (
            <>
              {/* Work Details Card */}
              <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <div>
                      <CardTitle>{work.title}</CardTitle>
                      <CardDescription>
                        {work.iswc && `ISWC: ${work.iswc}`}
                      </CardDescription>
                    </div>
                    <div className="flex gap-2">
                      {work.can_edit && (
                        <Button
                          variant="outline"
                          onClick={() => navigate(`/catalog/works/${work.id}/edit`)}
                        >
                          Edit Work
                        </Button>
                      )}
                      <Button
                        variant="outline"
                        onClick={() => navigate(`/catalog/works/${work.id}`)}
                      >
                        View Full Details
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <p className="text-sm text-muted-foreground">Language</p>
                      <p className="font-medium">{work.language || 'Not specified'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Genre</p>
                      <p className="font-medium">{work.genre || 'Not specified'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Year Composed</p>
                      <p className="font-medium">{work.year_composed || 'Not specified'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Created</p>
                      <p className="font-medium">
                        {formatDistanceToNow(new Date(work.created_at), { addSuffix: true })}
                      </p>
                    </div>
                  </div>
                  {work.notes && (
                    <div className="mt-4">
                      <p className="text-sm text-muted-foreground mb-1">Notes</p>
                      <p className="text-sm">{work.notes}</p>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Writer Splits */}
              {work.can_view_splits && work.writer_splits ? (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardHeader>
                    <CardTitle>Writer Splits</CardTitle>
                    <CardDescription>
                      Compositional ownership and royalty distribution
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {work.writer_splits.length === 0 ? (
                      <p className="text-center text-muted-foreground py-8">
                        No writer splits defined yet.
                      </p>
                    ) : (
                      <Table>
                        <TableHeader>
                          <TableRow>
                            <TableHead>Entity</TableHead>
                            <TableHead>Share</TableHead>
                            <TableHead>Source</TableHead>
                            <TableHead>Status</TableHead>
                          </TableRow>
                        </TableHeader>
                        <TableBody>
                          {work.writer_splits.map((split) => (
                            <TableRow key={split.id}>
                              <TableCell className="font-medium">
                                {split.entity_name}
                              </TableCell>
                              <TableCell>{split.share}%</TableCell>
                              <TableCell className="text-muted-foreground">
                                {split.source || 'Manual'}
                              </TableCell>
                              <TableCell>
                                {split.is_locked ? (
                                  <Badge variant="secondary">Locked</Badge>
                                ) : (
                                  <Badge variant="outline">Editable</Badge>
                                )}
                              </TableCell>
                            </TableRow>
                          ))}
                          <TableRow className="font-semibold bg-muted/50">
                            <TableCell>Total</TableCell>
                            <TableCell>
                              {work.writer_splits
                                .reduce((sum, s) => sum + parseFloat(s.share), 0)
                                .toFixed(2)}%
                            </TableCell>
                            <TableCell colSpan={2}>
                              {work.has_complete_publishing_splits ? (
                                <Badge variant="default" className="bg-green-500">
                                  Complete
                                </Badge>
                              ) : (
                                <Badge variant="destructive">Incomplete</Badge>
                              )}
                            </TableCell>
                          </TableRow>
                        </TableBody>
                      </Table>
                    )}
                  </CardContent>
                </Card>
              ) : !work.can_view_splits && work.writer_splits ? (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardHeader>
                    <CardTitle>Writers</CardTitle>
                    <CardDescription>
                      Compositional contributors (splits hidden)
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {work.writer_splits.length === 0 ? (
                      <p className="text-center text-muted-foreground py-8">
                        No writers defined yet.
                      </p>
                    ) : (
                      <div className="flex flex-wrap gap-2">
                        {work.writer_splits.map((split, idx) => (
                          <Badge key={idx} variant="secondary">
                            {split.entity_name}
                          </Badge>
                        ))}
                      </div>
                    )}
                  </CardContent>
                </Card>
              ) : null}

              {/* Publisher Splits */}
              {work.can_view_splits && work.publisher_splits && work.publisher_splits.length > 0 ? (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardHeader>
                    <CardTitle>Publisher Splits</CardTitle>
                    <CardDescription>
                      Publishing rights and royalty distribution
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Entity</TableHead>
                          <TableHead>Share</TableHead>
                          <TableHead>Source</TableHead>
                          <TableHead>Status</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {work.publisher_splits.map((split) => (
                          <TableRow key={split.id}>
                            <TableCell className="font-medium">
                              {split.entity_name}
                            </TableCell>
                            <TableCell>{split.share}%</TableCell>
                            <TableCell className="text-muted-foreground">
                              {split.source || 'Manual'}
                            </TableCell>
                            <TableCell>
                              {split.is_locked ? (
                                <Badge variant="secondary">Locked</Badge>
                              ) : (
                                <Badge variant="outline">Editable</Badge>
                              )}
                            </TableCell>
                          </TableRow>
                        ))}
                        <TableRow className="font-semibold bg-muted/50">
                          <TableCell>Total</TableCell>
                          <TableCell>
                            {work.publisher_splits
                              .reduce((sum, s) => sum + parseFloat(s.share), 0)
                              .toFixed(2)}%
                          </TableCell>
                          <TableCell colSpan={2}></TableCell>
                        </TableRow>
                      </TableBody>
                    </Table>
                  </CardContent>
                </Card>
              ) : !work.can_view_splits && work.publisher_splits && work.publisher_splits.length > 0 ? (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardHeader>
                    <CardTitle>Publishers</CardTitle>
                    <CardDescription>
                      Publishing representatives (splits hidden)
                    </CardDescription>
                  </CardHeader>
                  {canCreateRelease && (
                    <div className="flex flex-wrap gap-2">
                      {work.publisher_splits.map((split, idx) => (
                        <Badge key={idx} variant="secondary">
                          {split.entity_name}
                        </Badge>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              ) : null}

              {/* No Splits Permission Message */}
              {!work.can_view_splits && !work.writer_splits && !work.publisher_splits && (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardContent className="py-12">
                    <p className="text-center text-muted-foreground">
                      You do not have permission to view work splits.
                    </p>
                  </CardContent>
                </Card>
              )}
            </>
          ) : (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardContent className="py-12">
                <p className="text-center text-muted-foreground mb-6">No work linked to this song yet.</p>
                {canCreateWork && (
                  <div className="flex justify-center">
                    <Button
                      onClick={() => setShowCreateWorkDialog(true)}
                      
                      size="lg"
                      
                      className="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                    >
                      <Plus className="h-5 w-5 mr-2" />
                      Create Work
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="recording">
          <RecordingTab songId={songId} songStage={song.current_stage} songTitle={song.title} workId={song.work?.id} />
        </TabsContent>

        <TabsContent value="assets" className="space-y-6">
          {canReviewAssets && assets.some(a => a.review_status === 'pending') && (
            <Card className="rounded-2xl border-yellow-200/50 bg-yellow-50/50 backdrop-blur-xl shadow-lg">
              <CardContent className="py-4">
                <p className="text-sm font-medium text-yellow-800">
                  Assets Pending Review: {assets.filter(a => a.review_status === 'pending').length}
                </p>
                <p className="text-xs text-yellow-700 mt-1">
                  Please review all pending assets before sending this song to Digital Distribution.
                </p>
              </CardContent>
            </Card>
          )}

          <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle>Asset Gallery</CardTitle>
                  <p className="text-sm text-muted-foreground mt-1">
                    {assets.length === 0
                      ? 'No assets have been uploaded yet.'
                      : `${assets.length} ${assets.length === 1 ? 'asset' : 'assets'} uploaded`
                    }
                  </p>
                </div>
                {canUploadAssets && (
                  <Button
                    onClick={() => setShowUploadAssetDialog(true)}
                    
                      size="lg"
                    
                      className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg hover:shadow-xl transition-all duration-200"
                  >
                    <Upload className="mr-2 h-5 w-5" />
                    Upload Asset
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              {assets.length === 0 ? (
                <div className="py-12 text-center text-muted-foreground">
                  <Upload className="h-16 w-16 mx-auto mb-4 opacity-20" />
                  <p className="text-lg font-medium mb-2">No assets uploaded yet.</p>
                  {canUploadAssets && (
                    <p className="text-sm">Click the "Upload Asset" button above to add marketing materials.</p>
                  )}
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {assets.map((asset) => (
                    <AssetCard
                      key={asset.id}
                      asset={asset}
                      canReview={canReviewAssets}
                      onReview={(action, notes) =>
                        reviewAssetMutation.mutate({ assetId: asset.id, action, notes })
                      }
                    />
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Upload Asset Dialog */}
          <UploadAssetDialog
            songId={songId}
            open={showUploadAssetDialog}
            onOpenChange={setShowUploadAssetDialog}
            onUploadComplete={(asset) => {
              queryClient.invalidateQueries({ queryKey: ['song-assets', songId] });
              toast({
                title: 'Asset uploaded successfully',
                description: `"${asset.title}" has been uploaded and is pending review.`,
              });
            }}
          />
        </TabsContent>

        <TabsContent value="release" className="space-y-6">
          {!song.release ? (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardHeader>
                <CardTitle>Release</CardTitle>
                <CardDescription>
                  {canCreateRelease
                    ? 'Create a release to start distribution'
                    : 'No release created yet'}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="text-center py-12">
                  <p className="text-muted-foreground mb-4">
                    This song has not been set up for release yet.
                  </p>
                  {user?.profile?.department?.code === 'Digital' && (
                    <Button
                      onClick={() => setShowCreateReleaseDialog(true)}>
                      <Plus className="h-5 w-5 mr-2" />
                      Create Release
                    </Button>
                  )}
                </div>
              </CardContent>
            </Card>
          ) : releaseLoading || publicationsLoading ? (
            <div className="space-y-6">
              <Skeleton className="h-64 w-full" />
              <Skeleton className="h-96 w-full" />
            </div>
          ) : releaseData ? (
            <>
              {/* Release Details Card */}
              <ReleaseDetailsCard
                release={releaseData}
                canEdit={
                  user?.profile?.department?.code === 'Digital' ||
                  user?.profile?.role?.level >= 1000
                }
                onEdit={() => navigate(`/catalog/releases/${releaseData.id}/edit`)}
              />

              {/* Platform Distribution List */}
              {(user?.profile?.department?.code === 'Digital' ||
                user?.profile?.department?.code === 'Label' ||
                user?.profile?.department?.code === 'Marketing') && (
                <PlatformDistributionList publications={publications} />
              )}

              {/* Publication Timeline */}
              {(user?.profile?.department?.code === 'Digital' ||
                user?.profile?.department?.code === 'Label') && (
                <PublicationStatusTimeline publications={publications} />
              )}

              {/* Quick Actions */}
              {user?.profile?.department?.code === 'Digital' && (
                <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
                  <CardHeader>
                    <CardTitle>Quick Actions</CardTitle>
                  </CardHeader>
                  <CardContent className="flex gap-3">
                    <Button variant="outline" onClick={() => navigate(`/catalog/releases/${releaseData.id}`)}>
                      Full Release Details
                    </Button>
                    <Button variant="outline">
                      Add Platform
                    </Button>
                  </CardContent>
                </Card>
              )}
            </>
          ) : (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardContent className="py-12 text-center">
                <p className="text-muted-foreground">
                  Unable to load release details. Please try again later.
                </p>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="contracts" className="space-y-6">
          <ContractsTab 
            songId={songId} 
            workId={song?.work?.id} 
            releaseId={song?.release?.id} 
          />
        </TabsContent>

        <TabsContent value="activity" className="space-y-4">
          {/* Activity Log Header with Add Note Button and Filter */}
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-2">
              <Select value={activityFilter} onValueChange={(value) => setActivityFilter(value as 'all' | ActivityType)}>
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Filter by type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Activities</SelectItem>
                  <SelectItem value="transition">Stage Transitions</SelectItem>
                  <SelectItem value="note">Notes</SelectItem>
                  <SelectItem value="checklist">Checklist</SelectItem>
                  <SelectItem value="asset">Assets</SelectItem>
                </SelectContent>
              </Select>
              <span className="text-sm text-muted-foreground">
                {filteredActivities.length} {filteredActivities.length === 1 ? 'item' : 'items'}
              </span>
            </div>
            {!showAddNote && (
              <Button
                      onClick={() => setShowAddNote(true)}>
                <Plus className="h-5 w-5 mr-2" />
                Add Note
              </Button>
            )}
          </div>

          {/* Add Note Form */}
          {showAddNote && (
            <AddNoteForm
              onSubmit={async (content, isImportant) => {
                await createNoteMutation.mutateAsync({ content, is_important: isImportant });
              }}
              onCancel={() => setShowAddNote(false)}
            />
          )}

          {/* Activity List */}
          {filteredActivities.length === 0 ? (
            <Card className="rounded-2xl border-white/10 bg-background/50 backdrop-blur-xl shadow-xl">
              <CardContent className="py-12 text-center text-muted-foreground">
                {activityFilter === 'all'
                  ? 'No activity yet.'
                  : `No ${activityFilter} activities found.`}
              </CardContent>
            </Card>
          ) : (
            filteredActivities.map((item) => (
              <ActivityLogItem
                key={item.id}
                activity={item.data}
                type={item.type}
              />
            ))
          )}
        </TabsContent>
      </Tabs>

      {/* Create Work Dialog */}
      <CreateWorkDialog
        open={showCreateWorkDialog}
        onOpenChange={setShowCreateWorkDialog}
        songId={songId}
        songTitle={song.title}
        onSuccess={() => {
          queryClient.invalidateQueries({ queryKey: ['song', songId] });
          queryClient.invalidateQueries({ queryKey: ['song-work', songId] });
        }}
      />
    </div>
    </AppLayout>
  );
}
