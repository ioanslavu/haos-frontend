import { useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { ArrowLeft, Calendar, Clock, Loader2, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Skeleton } from '@/components/ui/skeleton';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { StageBadge } from '@/components/songs/StageBadge';
import { ProgressBar } from '@/components/songs/ProgressBar';
import { ChecklistSection } from '@/components/songs/ChecklistSection';
import { ActivityLogItem, ActivityType } from '@/components/songs/ActivityLogItem';
import { AssetCard } from '@/components/songs/AssetCard';
import { AssetUploader } from '@/components/songs/AssetUploader';
import { SongInfoCard } from '@/components/songs/SongInfoCard';
import { AddNoteForm } from '@/components/songs/AddNoteForm';
import { RecordingTab } from '@/components/songs/RecordingTab';
import { ReleaseDetailsCard } from '@/components/songs/ReleaseDetailsCard';
import { PlatformDistributionList } from '@/components/songs/PlatformDistributionList';
import { PublicationStatusTimeline } from '@/components/songs/PublicationStatusTimeline';
import {
  fetchSongDetail,
  fetchChecklist,
  toggleChecklistItem,
  validateAllChecklist,
  transitionSong,
  sendToMarketing,
  sendToDigital,
  fetchNotes,
  fetchStageTransitions,
  fetchAssets,
  reviewAsset,
  createNote,
  fetchSongWork,
  fetchReleasePublications,
} from '@/api/songApi';
import catalogService from '@/api/services/catalog.service';
import { useAuthStore } from '@/stores/authStore';
import { useToast } from '@/hooks/use-toast';
import { formatDistanceToNow } from 'date-fns';
import { AppLayout } from '@/components/layout/AppLayout';
import { SongStageTransition, SongNote, SongChecklistItem, SongAsset } from '@/types/song';

export default function SongDetailPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const { user } = useAuthStore();
  const { toast } = useToast();
  const [activeTab, setActiveTab] = useState('overview');
  const [showAssetUploader, setShowAssetUploader] = useState(false);
  const [showAddNote, setShowAddNote] = useState(false);
  const [activityFilter, setActivityFilter] = useState<'all' | ActivityType>('all');

  const songId = parseInt(id || '0');

  // Queries
  const { data: songData, isLoading: songLoading } = useQuery({
    queryKey: ['song', songId],
    queryFn: () => fetchSongDetail(songId),
    enabled: !!songId,
  });

  const { data: checklistData, isLoading: checklistLoading } = useQuery({
    queryKey: ['song-checklist', songId],
    queryFn: () => fetchChecklist(songId),
    enabled: !!songId,
  });

  const { data: notesData } = useQuery({
    queryKey: ['song-notes', songId],
    queryFn: () => fetchNotes(songId),
    enabled: !!songId,
  });

  const { data: transitionsData } = useQuery({
    queryKey: ['song-transitions', songId],
    queryFn: () => fetchStageTransitions(songId),
    enabled: !!songId,
  });

  const { data: assetsData } = useQuery({
    queryKey: ['song-assets', songId],
    queryFn: () => fetchAssets(songId),
    enabled: !!songId,
  });

  const { data: workData, isLoading: workLoading, error: workError } = useQuery({
    queryKey: ['song-work', songId],
    queryFn: () => fetchSongWork(songId),
    enabled: !!songId && activeTab === 'work',
  });

  const song = songData?.data;
  const checklist = Array.isArray(checklistData?.data) ? checklistData.data : [];
  const notes = Array.isArray(notesData?.data) ? notesData.data : [];
  const transitions = Array.isArray(transitionsData?.data) ? transitionsData.data : [];
  const assets = Array.isArray(assetsData?.data) ? assetsData.data : [];
  const work = workData?.data;

  // Release queries
  const { data: releaseData, isLoading: releaseLoading } = useQuery({
    queryKey: ['release', song?.release?.id],
    queryFn: () => catalogService.getRelease(song!.release!.id),
    enabled: !!song?.release?.id && activeTab === 'release',
  });

  const { data: publicationsData, isLoading: publicationsLoading } = useQuery({
    queryKey: ['release-publications', song?.release?.id],
    queryFn: () => fetchReleasePublications(song!.release!.id),
    enabled: !!song?.release?.id && activeTab === 'release',
  });

  const publications = Array.isArray(publicationsData?.data) ? publicationsData.data : [];

  // Mutations
  const toggleChecklistMutation = useMutation({
    mutationFn: (itemId: number) => toggleChecklistItem(songId, itemId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-checklist', songId] });
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
    },
  });

  const validateAllMutation = useMutation({
    mutationFn: () => validateAllChecklist(songId),
    onSuccess: (response) => {
      queryClient.invalidateQueries({ queryKey: ['song-checklist', songId] });
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Validation Complete',
        description: `${response.data.validated_count} items validated.`,
      });
    },
  });

  const sendToMarketingMutation = useMutation({
    mutationFn: () => sendToMarketing(songId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Success',
        description: 'Song sent to Marketing department.',
      });
    },
  });

  const sendToDigitalMutation = useMutation({
    mutationFn: () => sendToDigital(songId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song', songId] });
      toast({
        title: 'Success',
        description: 'Song sent to Digital Distribution.',
      });
    },
  });

  const reviewAssetMutation = useMutation({
    mutationFn: ({ assetId, action, notes }: { assetId: number; action: 'approve' | 'reject' | 'revision_requested'; notes?: string }) =>
      reviewAsset(songId, assetId, { action, notes }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-assets', songId] });
      toast({
        title: 'Asset Reviewed',
        description: 'Your review has been submitted.',
      });
    },
  });

  const createNoteMutation = useMutation({
    mutationFn: (data: { content: string; is_important: boolean }) => createNote(songId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['song-notes', songId] });
      setShowAddNote(false);
      toast({
        title: 'Note Added',
        description: 'Your note has been added to the activity log.',
      });
    },
  });

  // Combine and sort all activities
  const allActivities = useMemo(() => {
    type ActivityItem = {
      id: string;
      type: ActivityType;
      data: SongStageTransition | SongNote | SongChecklistItem | SongAsset;
      timestamp: string;
    };

    const items: ActivityItem[] = [];

    // Add transitions
    transitions.forEach((transition) => {
      items.push({
        id: `transition-${transition.id}`,
        type: 'transition',
        data: transition,
        timestamp: transition.created_at,
      });
    });

    // Add notes
    notes.forEach((note) => {
      items.push({
        id: `note-${note.id}`,
        type: 'note',
        data: note,
        timestamp: note.created_at,
      });
    });

    // Add completed checklist items
    checklist
      .filter((item) => item.is_completed && item.completed_at)
      .forEach((item) => {
        items.push({
          id: `checklist-${item.id}`,
          type: 'checklist',
          data: item,
          timestamp: item.completed_at!,
        });
      });

    // Add assets
    assets.forEach((asset) => {
      items.push({
        id: `asset-${asset.id}`,
        type: 'asset',
        data: asset,
        timestamp: asset.created_at,
      });
    });

    // Sort by timestamp (most recent first)
    return items.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
  }, [transitions, notes, checklist, assets]);

  // Filter activities
  const filteredActivities = useMemo(() => {
    if (activityFilter === 'all') {
      return allActivities;
    }
    return allActivities.filter((item) => item.type === activityFilter);
  }, [allActivities, activityFilter]);

  if (songLoading) {
    return (
      <div className="container mx-auto py-6 space-y-6">
        <Skeleton className="h-12 w-64" />
        <Skeleton className="h-96 w-full" />
      </div>
    );
  }

  if (!song) {
    return (
      <div className="container mx-auto py-12 text-center">
        <p className="text-muted-foreground">Song not found.</p>
        <Button onClick={() => navigate('/songs')} className="mt-4">
          Back to Songs
        </Button>
      </div>
    );
  }

  const canReviewAssets = user?.department === 'Label' && song.current_stage === 'label_review';
  const canUploadAssets = user?.department === 'Marketing' && song.current_stage === 'marketing_assets';
  const isComplete = song.checklist_progress === 100;
  const currentStage = song.current_stage || 'draft';

  return (
    <AppLayout>
      <div className="container mx-auto py-6 space-y-6">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => navigate('/songs')}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl font-bold">{song.title}</h1>
            <p className="text-muted-foreground">{song.artist?.display_name || 'No artist'}</p>
          </div>
          {song.current_stage && <StageBadge stage={song.current_stage} />}
        </div>

      <Card>
        <CardContent className="pt-6">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
              <p className="text-sm text-muted-foreground mb-1">Progress</p>
              <ProgressBar progress={song.checklist_progress} showLabel={true} />
            </div>
            <div>
              <p className="text-sm text-muted-foreground mb-1">Time in Stage</p>
              <p className="text-lg font-semibold">
                {song.days_in_current_stage} {song.days_in_current_stage === 1 ? 'day' : 'days'}
              </p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground mb-1">Target Release</p>
              <p className="text-lg font-semibold">
                {song.target_release_date
                  ? new Date(song.target_release_date).toLocaleDateString()
                  : 'Not set'}
              </p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground mb-1">Created</p>
              <p className="text-lg font-semibold">
                {formatDistanceToNow(new Date(song.created_at), { addSuffix: true })}
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList>
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="work">Work</TabsTrigger>
          <TabsTrigger value="recording">Recording</TabsTrigger>
          <TabsTrigger value="assets">Assets</TabsTrigger>
          <TabsTrigger value="release">Release</TabsTrigger>
          <TabsTrigger value="activity">Activity Log</TabsTrigger>
        </TabsList>

        <TabsContent value="overview" className="space-y-6">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Checklist Section - Takes up 2 columns */}
            <div className="lg:col-span-2">
              <ChecklistSection
                items={checklist}
                currentStage={currentStage}
                onToggle={(itemId) => toggleChecklistMutation.mutate(itemId)}
                onValidateAll={() => validateAllMutation.mutate()}
                onSendToMarketing={
                  currentStage === 'label_recording'
                    ? () => sendToMarketingMutation.mutate()
                    : undefined
                }
                onSendToDigital={
                  currentStage === 'ready_for_digital'
                    ? () => sendToDigitalMutation.mutate()
                    : undefined
                }
                isValidating={validateAllMutation.isPending}
                isSendingToMarketing={sendToMarketingMutation.isPending}
                isSendingToDigital={sendToDigitalMutation.isPending}
              />
            </div>

            {/* Song Info Card - Takes up 1 column */}
            <div className="lg:col-span-1">
              <SongInfoCard song={song} />
            </div>
          </div>

          {/* Recent Activity */}
          <Card>
            <CardHeader>
              <CardTitle>Recent Activity</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {notes.length === 0 ? (
                <p className="text-muted-foreground text-center py-8">No activity yet.</p>
              ) : (
                notes.slice(0, 5).map((note) => (
                  <ActivityLogItem key={note.id} activity={note} type="note" />
                ))
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="work">
          <Card>
            <CardHeader>
              <CardTitle>Work Details</CardTitle>
            </CardHeader>
            <CardContent>
              {song.work ? (
                <div>
                  <p className="text-sm text-muted-foreground">Work ID: {song.work.id}</p>
                  {song.work.iswc && (
                    <p className="text-sm text-muted-foreground">ISWC: {song.work.iswc}</p>
                  )}
                  <Button variant="outline" className="mt-4" onClick={() => navigate(`/catalog/works/${song.work?.id}`)}>
                    View Work Details
                  </Button>
                </div>
              ) : (
                <p className="text-muted-foreground">No work created yet.</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="recording">
          <RecordingTab songId={songId} songStage={song.current_stage} />
        </TabsContent>

        <TabsContent value="assets" className="space-y-6">
          {canUploadAssets && (
            <Card>
              <CardHeader>
                <CardTitle>Upload Marketing Assets</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Upload cover art, promotional graphics, press photos, and other marketing materials for this song.
                </p>
              </CardHeader>
              <CardContent>
                {!showAssetUploader ? (
                  <Button onClick={() => setShowAssetUploader(true)}>
                    Upload New Asset
                  </Button>
                ) : (
                  <AssetUploader
                    songId={songId}
                    onUploadComplete={(asset) => {
                      queryClient.invalidateQueries({ queryKey: ['song-assets', songId] });
                      setShowAssetUploader(false);
                      toast({ title: 'Asset uploaded successfully' });
                    }}
                    onCancel={() => setShowAssetUploader(false)}
                  />
                )}
              </CardContent>
            </Card>
          )}

          {canReviewAssets && assets.some(a => a.review_status === 'pending') && (
            <Card className="border-yellow-200 bg-yellow-50">
              <CardContent className="py-4">
                <p className="text-sm font-medium text-yellow-800">
                  Assets Pending Review: {assets.filter(a => a.review_status === 'pending').length}
                </p>
                <p className="text-xs text-yellow-700 mt-1">
                  Please review all pending assets before sending this song to Digital Distribution.
                </p>
              </CardContent>
            </Card>
          )}

          <Card>
            <CardHeader>
              <CardTitle>Asset Gallery</CardTitle>
              <p className="text-sm text-muted-foreground">
                {assets.length === 0
                  ? 'No assets have been uploaded yet.'
                  : `${assets.length} ${assets.length === 1 ? 'asset' : 'assets'} uploaded`
                }
              </p>
            </CardHeader>
            <CardContent>
              {assets.length === 0 ? (
                <div className="py-12 text-center text-muted-foreground">
                  <p>No assets uploaded yet.</p>
                  {canUploadAssets && (
                    <p className="text-xs mt-2">Click "Upload New Asset" above to add marketing materials.</p>
                  )}
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {assets.map((asset) => (
                    <AssetCard
                      key={asset.id}
                      asset={asset}
                      canReview={canReviewAssets}
                      onReview={(action, notes) =>
                        reviewAssetMutation.mutate({ assetId: asset.id, action, notes })
                      }
                    />
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="release" className="space-y-6">
          {!song.release ? (
            <Card>
              <CardHeader>
                <CardTitle>Release</CardTitle>
                <CardDescription>
                  {user?.profile?.department?.code === 'Digital'
                    ? 'Create a release to start distribution'
                    : 'No release created yet'}
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="text-center py-12">
                  <p className="text-muted-foreground mb-4">
                    This song has not been set up for release yet.
                  </p>
                  {user?.profile?.department?.code === 'Digital' && (
                    <Button onClick={() => navigate(`/catalog/releases/new?song=${songId}`)}>
                      <Plus className="h-4 w-4 mr-2" />
                      Create Release
                    </Button>
                  )}
                </div>
              </CardContent>
            </Card>
          ) : releaseLoading || publicationsLoading ? (
            <div className="space-y-6">
              <Skeleton className="h-64 w-full" />
              <Skeleton className="h-96 w-full" />
            </div>
          ) : releaseData ? (
            <>
              {/* Release Details Card */}
              <ReleaseDetailsCard
                release={releaseData}
                canEdit={
                  user?.profile?.department?.code === 'Digital' ||
                  user?.profile?.role?.level >= 1000
                }
                onEdit={() => navigate(`/catalog/releases/${releaseData.id}/edit`)}
              />

              {/* Platform Distribution List */}
              {(user?.profile?.department?.code === 'Digital' ||
                user?.profile?.department?.code === 'Label' ||
                user?.profile?.department?.code === 'Marketing') && (
                <PlatformDistributionList publications={publications} />
              )}

              {/* Publication Timeline */}
              {(user?.profile?.department?.code === 'Digital' ||
                user?.profile?.department?.code === 'Label') && (
                <PublicationStatusTimeline publications={publications} />
              )}

              {/* Quick Actions */}
              {user?.profile?.department?.code === 'Digital' && (
                <Card>
                  <CardHeader>
                    <CardTitle>Quick Actions</CardTitle>
                  </CardHeader>
                  <CardContent className="flex gap-3">
                    <Button variant="outline" onClick={() => navigate(`/catalog/releases/${releaseData.id}`)}>
                      Full Release Details
                    </Button>
                    <Button variant="outline">
                      Add Platform
                    </Button>
                  </CardContent>
                </Card>
              )}
            </>
          ) : (
            <Card>
              <CardContent className="py-12 text-center">
                <p className="text-muted-foreground">
                  Unable to load release details. Please try again later.
                </p>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="activity" className="space-y-4">
          {/* Activity Log Header with Add Note Button and Filter */}
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-2">
              <Select value={activityFilter} onValueChange={(value) => setActivityFilter(value as 'all' | ActivityType)}>
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Filter by type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Activities</SelectItem>
                  <SelectItem value="transition">Stage Transitions</SelectItem>
                  <SelectItem value="note">Notes</SelectItem>
                  <SelectItem value="checklist">Checklist</SelectItem>
                  <SelectItem value="asset">Assets</SelectItem>
                </SelectContent>
              </Select>
              <span className="text-sm text-muted-foreground">
                {filteredActivities.length} {filteredActivities.length === 1 ? 'item' : 'items'}
              </span>
            </div>
            {!showAddNote && (
              <Button onClick={() => setShowAddNote(true)}>
                <Plus className="h-4 w-4 mr-2" />
                Add Note
              </Button>
            )}
          </div>

          {/* Add Note Form */}
          {showAddNote && (
            <AddNoteForm
              onSubmit={async (content, isImportant) => {
                await createNoteMutation.mutateAsync({ content, is_important: isImportant });
              }}
              onCancel={() => setShowAddNote(false)}
            />
          )}

          {/* Activity List */}
          {filteredActivities.length === 0 ? (
            <Card>
              <CardContent className="py-12 text-center text-muted-foreground">
                {activityFilter === 'all'
                  ? 'No activity yet.'
                  : `No ${activityFilter} activities found.`}
              </CardContent>
            </Card>
          ) : (
            filteredActivities.map((item) => (
              <ActivityLogItem
                key={item.id}
                activity={item.data}
                type={item.type}
              />
            ))
          )}
        </TabsContent>
      </Tabs>
    </div>
    </AppLayout>
  );
}
